const Rt=9.80665,bt=287.058,It=461.495,Dt=101325,St=288.15,At=.0065,gt=72921159e-12,H=.3048,E=.0254,V=.9144,ft=.44704,_t=6479891e-11,wt=3386.389,st=1.355818;function ht(a,s,n){return Math.max(s,Math.min(n,a))}function g(a){return a*Math.PI/180}function Tt(a){return a*180/Math.PI}function ct(a,s){return s<=0?0:a/(s*1.047)}function it(a,s){return s<=0?0:a/(s*3.6)}function U(a){return a.weightGrains*_t}function kt(a){const s=a.diameterIn*E;return Math.PI*Math.pow(.5*s,2)}function Ct(a){return a.weightGrains/7e3/Math.pow(a.diameterIn,2)}class Ft{constructor(s){this.env=s,this.temperatureK=0,this.pressurePa=0,this.rhoKgM3=0,this.aMs=0,this.compute()}compute(){const s=(this.env.temperatureF-32)*.5555555555555556,n=s+273.15;let o;if(this.env.pressureInHg!==void 0)o=this.env.pressureInHg*wt;else{const x=this.env.altitudeFt*H;o=101325*Math.pow(1-.0065*x/288.15,9.80665/(287.058*.0065))}const c=6.1078*Math.pow(10,7.5*s/(s+237.3))*100,v=ht(this.env.relativeHumidityPercent,0,100)/100*c,r=Math.max(o-v,1)/(287.058*n)+v/(461.495*n),M=Math.sqrt(1.4*287.058*n);this.temperatureK=n,this.pressurePa=o,this.rhoKgM3=r,this.aMs=M}windVectorMpsShotFrame(s){const n=this.env.windSpeedMph*ft,o=g(this.env.windFromDirectionDeg),h=-n*Math.cos(o),c=-n*Math.sin(o);return[h,c,0]}}class Ht{constructor(s=.3){this._cd=s}cd(s){return this._cd}}class Et{constructor(s,n){if(s.length<2||s.length!==n.length)throw new Error("Invalid Cd table data");this.mach=[...s],this.cdv=[...n]}cd(s){const n=s;if(n<=this.mach[0])return this.cdv[0];if(n>=this.mach[this.mach.length-1])return this.cdv[this.cdv.length-1];let o=0,h=this.mach.length-1;for(;h-o>1;){const i=Math.floor((o+h)/2);this.mach[i]<=n?o=i:h=i}const c=(n-this.mach[o])/(this.mach[h]-this.mach[o]);return this.cdv[o]*(1-c)+this.cdv[h]*c}}class Gt{constructor(s,n){this.ref=s,this.i=n}cd(s){return this.i*this.ref.cd(s)}}function Pt(a,s,n,o,h){const c=g(h),i=[Math.sin(c),Math.cos(c),0],v=[Math.cos(c),-Math.sin(c),0],t=[0,0,1],r=a*i[0]+s*v[0]+n*t[0],l=a*i[1]+s*v[1]+n*t[1],M=a*i[2]+s*v[2]+n*t[2],x=g(o),f=gt,R=f*Math.cos(x),b=f*Math.sin(x),m=[R,0,b],z=-2*(m[1]*M-m[2]*l),p=-2*(m[2]*r-m[0]*M),I=-2*(m[0]*l-m[1]*r),j=z*i[0]+p*i[1]+I*i[2],_=z*v[0]+p*v[1]+I*v[2],u=z*t[0]+p*t[1]+I*t[2];return[j,_,u]}class Ot{constructor(s,n,o,h,c=!1,i=0){this.bullet=s,this.rifle=n,this.env=o,this.cdProvider=h,this.includeCoriolis=c,this.shotAzDeg=i,this.atm=new Ft(o)}initialElevationAngleRad(){const s=this.rifle.zeroRangeYd*V,n=this.rifle.sightHeightIn*E,o=t=>{const[,,r]=this.propagateToX(t,s);return r-n};let h=g(-2),c=g(10),i=o(h),v=o(c);for(let t=0;t<20&&!(i*v<=0);t++)c+=g(5),v=o(c);if(i*v>0)return g(1);for(let t=0;t<50;t++){const r=.5*(h+c),l=o(r);if(Math.abs(l)<1e-5)return r;i*l<=0?(c=r,v=l):(h=r,i=l)}return .5*(h+c)}propagateToX(s,n){const o=this.integrate(s,n,void 0),h=o[o.length-1];for(let c=1;c<o.length;c++)if(o[c].xM>=n){const i=o[c-1],v=o[c],t=(n-i.xM)/Math.max(1e-9,v.xM-i.xM),r=n,l=i.yM+t*(v.yM-i.yM),M=i.zM+t*(v.zM-i.zM);return[r,l,M]}return[h.xM,h.yM,h.zM]}computeTrajectory(s=1e3,n=25){const o=this.initialElevationAngleRad(),h=s*V,c=n*V,i=this.integrate(o,h,c),v=this.rifle.sightHeightIn*E,t=[];for(const r of i){const l=r.xM/V,M=(v-r.zM)/E,x=r.yM/E,f=ct(M,Math.max(l,1e-9)),R=it(M,Math.max(l,1e-9)),b=ct(x,Math.max(l,1e-9)),m=it(x,Math.max(l,1e-9));t.push({rangeYd:l,xM:r.xM,yM:r.yM,zM:r.zM,dropIn:M,windIn:x,timeS:r.timeS,velFps:r.velFps,mach:r.mach,energyFtlb:r.energyFtlb,dropMoa:f,dropMil:R,windMoa:b,windMil:m})}return t}integrate(s,n,o){const h=this.rifle.muzzleVelocityFps*H,c=h*Math.cos(s),i=0,v=h*Math.sin(s),t={x:0,y:0,z:0,vx:c,vy:i,vz:v,t:0},r=this.atm.rhoKgM3,l=this.atm.aMs,M=U(this.bullet),x=kt(this.bullet),f=9.80665,[R,b,m]=this.atm.windVectorMpsShotFrame(this.shotAzDeg),z=[];let p=o!==void 0?0:1/0;const I=1e6,j=.5,_=(u,G,e,w,O,Y)=>{const k=w-R,F=O-b,P=Y-m,y=Math.sqrt(k*k+F*F+P*P)+1e-12,D=y/l,S=ht(this.cdProvider.cd(D),.05,2),A=.5*r*S*x/M;let K=-A*y*k,L=-A*y*F,T=-A*y*P-f;if(this.includeCoriolis){const[q,N,C]=Pt(w,O,Y,this.env.latitudeDeg,this.shotAzDeg);K+=q,L+=N,T+=C}return[K,L,T]};for(let u=0;u<I;u++){const G=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz)+1e-9,e=j/G,[w,O,Y]=_(t.x,t.y,t.z,t.vx,t.vy,t.vz),k=t.vx,F=t.vy,P=t.vz,y=w,D=O,S=Y,[A,K,L]=_(t.x+.5*e*k,t.y+.5*e*F,t.z+.5*e*P,t.vx+.5*e*y,t.vy+.5*e*D,t.vz+.5*e*S),T=t.vx+.5*e*y,q=t.vy+.5*e*D,N=t.vz+.5*e*S,C=A,B=K,J=L,[rt,at,vt]=_(t.x+.5*e*T,t.y+.5*e*q,t.z+.5*e*N,t.vx+.5*e*C,t.vy+.5*e*B,t.vz+.5*e*J),nt=t.vx+.5*e*C,ot=t.vy+.5*e*B,et=t.vz+.5*e*J,Q=rt,W=at,X=vt,[lt,Mt,xt]=_(t.x+e*nt,t.y+e*ot,t.z+e*et,t.vx+e*Q,t.vy+e*W,t.vz+e*X),mt=t.vx+e*Q,ut=t.vy+e*W,zt=t.vz+e*X,dt=lt,yt=Mt,pt=xt;if(t.x+=e/6*(k+2*T+2*nt+mt),t.y+=e/6*(F+2*q+2*ot+ut),t.z+=e/6*(P+2*N+2*et+zt),t.vx+=e/6*(y+2*C+2*Q+dt),t.vy+=e/6*(D+2*B+2*W+yt),t.vz+=e/6*(S+2*J+2*X+pt),t.t+=e,t.x>=n||t.z<-50){const d=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz),Z=d/H,$=d/l,tt=.5*U(this.bullet)*d*d/st;z.push({xM:t.x,yM:t.y,zM:t.z,timeS:t.t,velFps:Z,mach:$,energyFtlb:tt});break}if(o!==void 0)for(;t.x>=p&&p<=n;){const d=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz),Z=d/H,$=d/l,tt=.5*U(this.bullet)*d*d/st;z.push({xM:t.x,yM:t.y,zM:t.z,timeS:t.t,velFps:Z,mach:$,energyFtlb:tt}),p+=o}}if(z.length===0){const u=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz),G=u/H,e=u/this.atm.aMs,w=.5*U(this.bullet)*u*u/st;z.push({xM:t.x,yM:t.y,zM:t.z,timeS:t.t,velFps:G,mach:e,energyFtlb:w})}return z}}export{Ft as Atmosphere,Ot as BallisticsEngine,Ht as ConstantCdProvider,Et as CustomCdTableProvider,H as FT_TO_M,Rt as G0,_t as GR_TO_KG,wt as INHG_TO_PA,E as IN_TO_M,st as J_PER_FT_LBF,At as L,ft as MPH_TO_MPS,gt as OMEGA_E,Dt as P0,bt as R_DRY,It as R_VAPOR,Gt as ScaledReferenceProvider,St as T0,V as YARD_TO_M,kt as bulletAreaM2,U as bulletMassKg,Ct as bulletSectionalDensity,ht as clamp,Pt as coriolisAccelShotFrame,g as degToRad,it as milsFromInchesAtYards,ct as moaFromInchesAtYards,Tt as radToDeg};
